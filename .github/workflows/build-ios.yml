name: Build iOS App

# Trigger this workflow manually or on push to main
on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main

jobs:
  build:
    name: Build Blab iOS App
    runs-on: macos-14  # Latest macOS with Xcode 15

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Show build environment
      - name: Show build environment
        run: |
          xcodebuild -version
          swift --version
          echo "macOS version:"
          sw_vers

      # Step 3: Copy Info.plist to project root
      - name: Setup Info.plist
        run: |
          ls -la
          echo "‚úÖ Info.plist exists in repo"

      # Step 4: Create minimal Xcode project structure manually
      - name: Create Xcode project structure
        run: |
          # Create Xcode project directory
          mkdir -p Blab.xcodeproj

          # Create project.pbxproj file
          cat > Blab.xcodeproj/project.pbxproj << 'EOF'
          // !$*UTF8*$!
          {
            archiveVersion = 1;
            classes = {
            };
            objectVersion = 56;
            objects = {
              /* Begin PBXBuildFile section */
              A1000001 /* BlabApp.swift in Sources */ = {isa = PBXBuildFile; fileRef = A2000001; };
              A1000002 /* ContentView.swift in Sources */ = {isa = PBXBuildFile; fileRef = A2000002; };
              A1000003 /* MicrophoneManager.swift in Sources */ = {isa = PBXBuildFile; fileRef = A2000003; };
              A1000004 /* ParticleView.swift in Sources */ = {isa = PBXBuildFile; fileRef = A2000004; };
              /* End PBXBuildFile section */

              /* Begin PBXFileReference section */
              A3000001 /* Blab.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = Blab.app; sourceTree = BUILT_PRODUCTS_DIR; };
              A2000001 /* BlabApp.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = BlabApp.swift; sourceTree = "<group>"; };
              A2000002 /* ContentView.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ContentView.swift; sourceTree = "<group>"; };
              A2000003 /* MicrophoneManager.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = MicrophoneManager.swift; sourceTree = "<group>"; };
              A2000004 /* ParticleView.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ParticleView.swift; sourceTree = "<group>"; };
              /* End PBXFileReference section */

              /* Begin PBXFrameworksBuildPhase section */
              A4000001 /* Frameworks */ = {
                isa = PBXFrameworksBuildPhase;
                buildActionMask = 2147483647;
                files = (
                );
                runOnlyForDeploymentPostprocessing = 0;
              };
              /* End PBXFrameworksBuildPhase section */

              /* Begin PBXGroup section */
              A5000001 = {
                isa = PBXGroup;
                children = (
                  A5000002 /* Blab */,
                  A5000003 /* Products */,
                );
                sourceTree = "<group>";
              };
              A5000002 /* Blab */ = {
                isa = PBXGroup;
                children = (
                  A2000001 /* BlabApp.swift */,
                  A2000002 /* ContentView.swift */,
                  A2000003 /* MicrophoneManager.swift */,
                  A2000004 /* ParticleView.swift */,
                );
                path = Sources/Blab;
                sourceTree = "<group>";
              };
              A5000003 /* Products */ = {
                isa = PBXGroup;
                children = (
                  A3000001 /* Blab.app */,
                );
                name = Products;
                sourceTree = "<group>";
              };
              /* End PBXGroup section */

              /* Begin PBXNativeTarget section */
              A6000001 /* Blab */ = {
                isa = PBXNativeTarget;
                buildConfigurationList = A7000001;
                buildPhases = (
                  A8000001 /* Sources */,
                  A4000001 /* Frameworks */,
                );
                buildRules = (
                );
                dependencies = (
                );
                name = Blab;
                productName = Blab;
                productReference = A3000001;
                productType = "com.apple.product-type.application";
              };
              /* End PBXNativeTarget section */

              /* Begin PBXProject section */
              A9000001 /* Project object */ = {
                isa = PBXProject;
                attributes = {
                  BuildIndependentTargetsInParallel = 1;
                  LastSwiftUpdateCheck = 1500;
                  LastUpgradeCheck = 1500;
                };
                buildConfigurationList = A9000002;
                compatibilityVersion = "Xcode 14.0";
                developmentRegion = en;
                hasScannedForEncodings = 0;
                knownRegions = (
                  en,
                  Base,
                );
                mainGroup = A5000001;
                productRefGroup = A5000003;
                projectDirPath = "";
                projectRoot = "";
                targets = (
                  A6000001 /* Blab */,
                );
              };
              /* End PBXProject section */

              /* Begin PBXSourcesBuildPhase section */
              A8000001 /* Sources */ = {
                isa = PBXSourcesBuildPhase;
                buildActionMask = 2147483647;
                files = (
                  A1000001 /* BlabApp.swift in Sources */,
                  A1000002 /* ContentView.swift in Sources */,
                  A1000003 /* MicrophoneManager.swift in Sources */,
                  A1000004 /* ParticleView.swift in Sources */,
                );
                runOnlyForDeploymentPostprocessing = 0;
              };
              /* End PBXSourcesBuildPhase section */

              /* Begin XCBuildConfiguration section */
              AA000001 /* Debug */ = {
                isa = XCBuildConfiguration;
                buildSettings = {
                  ALWAYS_SEARCH_USER_PATHS = NO;
                  CLANG_ANALYZER_NONNULL = YES;
                  CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE;
                  CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
                  CLANG_ENABLE_MODULES = YES;
                  CLANG_ENABLE_OBJC_ARC = YES;
                  CLANG_ENABLE_OBJC_WEAK = YES;
                  CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES;
                  CLANG_WARN_BOOL_CONVERSION = YES;
                  CLANG_WARN_COMMA = YES;
                  CLANG_WARN_CONSTANT_CONVERSION = YES;
                  CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES;
                  CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR;
                  CLANG_WARN_DOCUMENTATION_COMMENTS = YES;
                  CLANG_WARN_EMPTY_BODY = YES;
                  CLANG_WARN_ENUM_CONVERSION = YES;
                  CLANG_WARN_INFINITE_RECURSION = YES;
                  CLANG_WARN_INT_CONVERSION = YES;
                  CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES;
                  CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES;
                  CLANG_WARN_OBJC_LITERAL_CONVERSION = YES;
                  CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR;
                  CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES;
                  CLANG_WARN_RANGE_LOOP_ANALYSIS = YES;
                  CLANG_WARN_STRICT_PROTOTYPES = YES;
                  CLANG_WARN_SUSPICIOUS_MOVE = YES;
                  CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE;
                  CLANG_WARN_UNREACHABLE_CODE = YES;
                  CLANG_WARN__DUPLICATE_METHOD_MATCH = YES;
                  COPY_PHASE_STRIP = NO;
                  DEBUG_INFORMATION_FORMAT = dwarf;
                  ENABLE_STRICT_OBJC_MSGSEND = YES;
                  ENABLE_TESTABILITY = YES;
                  GCC_C_LANGUAGE_STANDARD = gnu11;
                  GCC_DYNAMIC_NO_PIC = NO;
                  GCC_NO_COMMON_BLOCKS = YES;
                  GCC_OPTIMIZATION_LEVEL = 0;
                  GCC_PREPROCESSOR_DEFINITIONS = (
                    "DEBUG=1",
                    "$(inherited)",
                  );
                  GCC_WARN_64_TO_32_BIT_CONVERSION = YES;
                  GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR;
                  GCC_WARN_UNDECLARED_SELECTOR = YES;
                  GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE;
                  GCC_WARN_UNUSED_FUNCTION = YES;
                  GCC_WARN_UNUSED_VARIABLE = YES;
                  IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                  MTL_ENABLE_DEBUG_INFO = INCLUDE_SOURCE;
                  MTL_FAST_MATH = YES;
                  ONLY_ACTIVE_ARCH = YES;
                  SDKROOT = iphoneos;
                  SWIFT_ACTIVE_COMPILATION_CONDITIONS = DEBUG;
                  SWIFT_OPTIMIZATION_LEVEL = "-Onone";
                };
                name = Debug;
              };
              AA000002 /* Release */ = {
                isa = XCBuildConfiguration;
                buildSettings = {
                  ALWAYS_SEARCH_USER_PATHS = NO;
                  CLANG_ANALYZER_NONNULL = YES;
                  CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE;
                  CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
                  CLANG_ENABLE_MODULES = YES;
                  CLANG_ENABLE_OBJC_ARC = YES;
                  CLANG_ENABLE_OBJC_WEAK = YES;
                  CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES;
                  CLANG_WARN_BOOL_CONVERSION = YES;
                  CLANG_WARN_COMMA = YES;
                  CLANG_WARN_CONSTANT_CONVERSION = YES;
                  CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES;
                  CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR;
                  CLANG_WARN_DOCUMENTATION_COMMENTS = YES;
                  CLANG_WARN_EMPTY_BODY = YES;
                  CLANG_WARN_ENUM_CONVERSION = YES;
                  CLANG_WARN_INFINITE_RECURSION = YES;
                  CLANG_WARN_INT_CONVERSION = YES;
                  CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES;
                  CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES;
                  CLANG_WARN_OBJC_LITERAL_CONVERSION = YES;
                  CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR;
                  CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES;
                  CLANG_WARN_RANGE_LOOP_ANALYSIS = YES;
                  CLANG_WARN_STRICT_PROTOTYPES = YES;
                  CLANG_WARN_SUSPICIOUS_MOVE = YES;
                  CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE;
                  CLANG_WARN_UNREACHABLE_CODE = YES;
                  CLANG_WARN__DUPLICATE_METHOD_MATCH = YES;
                  COPY_PHASE_STRIP = NO;
                  DEBUG_INFORMATION_FORMAT = "dwarf-with-dsym";
                  ENABLE_NS_ASSERTIONS = NO;
                  ENABLE_STRICT_OBJC_MSGSEND = YES;
                  GCC_C_LANGUAGE_STANDARD = gnu11;
                  GCC_NO_COMMON_BLOCKS = YES;
                  GCC_WARN_64_TO_32_BIT_CONVERSION = YES;
                  GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR;
                  GCC_WARN_UNDECLARED_SELECTOR = YES;
                  GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE;
                  GCC_WARN_UNUSED_FUNCTION = YES;
                  GCC_WARN_UNUSED_VARIABLE = YES;
                  IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                  MTL_ENABLE_DEBUG_INFO = NO;
                  MTL_FAST_MATH = YES;
                  SDKROOT = iphoneos;
                  SWIFT_COMPILATION_MODE = wholemodule;
                  SWIFT_OPTIMIZATION_LEVEL = "-O";
                  VALIDATE_PRODUCT = YES;
                };
                name = Release;
              };
              AB000001 /* Debug */ = {
                isa = XCBuildConfiguration;
                buildSettings = {
                  ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
                  ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor;
                  CODE_SIGN_IDENTITY = "";
                  CODE_SIGN_STYLE = Automatic;
                  CURRENT_PROJECT_VERSION = 1;
                  DEVELOPMENT_TEAM = "";
                  ENABLE_PREVIEWS = YES;
                  GENERATE_INFOPLIST_FILE = YES;
                  INFOPLIST_KEY_NSMicrophoneUsageDescription = "Blab needs microphone access to create music from your voice and breath";
                  INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
                  INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
                  INFOPLIST_KEY_UILaunchScreen_Generation = YES;
                  INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown";
                  IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                  LD_RUNPATH_SEARCH_PATHS = (
                    "$(inherited)",
                    "@executable_path/Frameworks",
                  );
                  MARKETING_VERSION = 1.0;
                  PRODUCT_BUNDLE_IDENTIFIER = com.blab.studio;
                  PRODUCT_NAME = "$(TARGET_NAME)";
                  SWIFT_EMIT_LOC_STRINGS = YES;
                  SWIFT_VERSION = 5.0;
                  TARGETED_DEVICE_FAMILY = "1";
                };
                name = Debug;
              };
              AB000002 /* Release */ = {
                isa = XCBuildConfiguration;
                buildSettings = {
                  ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
                  ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor;
                  CODE_SIGN_IDENTITY = "";
                  CODE_SIGN_STYLE = Automatic;
                  CURRENT_PROJECT_VERSION = 1;
                  DEVELOPMENT_TEAM = "";
                  ENABLE_PREVIEWS = YES;
                  GENERATE_INFOPLIST_FILE = YES;
                  INFOPLIST_KEY_NSMicrophoneUsageDescription = "Blab needs microphone access to create music from your voice and breath";
                  INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
                  INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
                  INFOPLIST_KEY_UILaunchScreen_Generation = YES;
                  INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown";
                  IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                  LD_RUNPATH_SEARCH_PATHS = (
                    "$(inherited)",
                    "@executable_path/Frameworks",
                  );
                  MARKETING_VERSION = 1.0;
                  PRODUCT_BUNDLE_IDENTIFIER = com.blab.studio;
                  PRODUCT_NAME = "$(TARGET_NAME)";
                  SWIFT_EMIT_LOC_STRINGS = YES;
                  SWIFT_VERSION = 5.0;
                  TARGETED_DEVICE_FAMILY = "1";
                };
                name = Release;
              };
              /* End XCBuildConfiguration section */

              /* Begin XCConfigurationList section */
              A7000001 /* Build configuration list for PBXNativeTarget "Blab" */ = {
                isa = XCConfigurationList;
                buildConfigurations = (
                  AB000001 /* Debug */,
                  AB000002 /* Release */,
                );
                defaultConfigurationIsVisible = 0;
                defaultConfigurationName = Release;
              };
              A9000002 /* Build configuration list for PBXProject "Blab" */ = {
                isa = XCConfigurationList;
                buildConfigurations = (
                  AA000001 /* Debug */,
                  AA000002 /* Release */,
                );
                defaultConfigurationIsVisible = 0;
                defaultConfigurationName = Release;
              };
              /* End XCConfigurationList section */
            };
            rootObject = A9000001 /* Project object */;
          }
          EOF

          echo "‚úÖ Xcode project created"
          ls -la Blab.xcodeproj/

      # Step 4: Build the app for iOS
      - name: Build iOS app
        run: |
          xcodebuild \
            -project Blab.xcodeproj \
            -scheme Blab \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      # Step 5: Create IPA file (if build succeeds)
      - name: Create IPA
        run: |
          # Find the .app bundle
          APP_PATH=$(find build -name "Blab.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Blab.app not found"
            find build -name "*.app"
            exit 1
          fi

          echo "‚úÖ Found app at: $APP_PATH"

          # Create Payload directory structure
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/

          # Zip it into an IPA
          zip -r Blab-unsigned.ipa Payload

          echo "‚úÖ IPA created: Blab-unsigned.ipa"
          ls -lh Blab-unsigned.ipa

      # Step 6: Upload IPA as artifact
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Blab-iOS-App
          path: Blab-unsigned.ipa
          retention-days: 30

      # Step 7: Show success message
      - name: Build complete
        run: |
          echo "üéâ Build successful!"
          echo "üì¶ Download the IPA from the Actions tab"
          echo "üì± Install on iPhone using Sideloadly or Apple Configurator"
